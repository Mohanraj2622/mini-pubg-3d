<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Mobile Zombie Apocalypse</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      -webkit-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
      user-select: none;
      -webkit-touch-callout: none;
      -webkit-tap-highlight-color: transparent;
    }
    
    body {
      background: linear-gradient(180deg, #8B0000 0%, #4B0000 30%, #1a1a2e 60%, #0f0f0f 100%);
      overflow: hidden;
      font-family: 'Arial', sans-serif;
      height: 100vh;
      width: 100vw;
      position: fixed;
      touch-action: manipulation;
    }
    
    .game-container {
      position: relative;
      width: 100vw;
      height: 100vh;
      overflow: hidden;
    }
    
    .background {
      position: absolute;
      top: 0;
      left: 0;
      width: 200%;
      height: 100%;
      background: linear-gradient(180deg, #654321 0%, #4a3016 50%, #2d1b0d 100%);
      animation: scroll-bg 20s linear infinite;
    }
    
    .underground {
      position: absolute;
      bottom: 0;
      width: 100%;
      height: 25vh;
      background: linear-gradient(180deg, #654321 0%, #4a3016 50%, #2d1b0d 100%);
      border-top: 8px solid #8b4513;
    }
    
    .ground-surface {
      position: absolute;
      bottom: 25vh;
      width: 100%;
      height: 8vh;
      background: #2d5016;
      border-top: 5px solid #4a7c28;
    }
    
    .environment {
      position: absolute;
      width: 200%;
      height: 100%;
      animation: scroll-env 15s linear infinite;
    }
    
    .tree {
      position: absolute;
      bottom: 33vh;
      width: 12vw;
      height: 25vh;
      min-width: 60px;
      min-height: 180px;
    }
    
    .tree-trunk {
      position: absolute;
      bottom: 0;
      left: 35%;
      width: 30%;
      height: 45%;
      background: #4a3016;
      border-radius: 8px;
    }
    
    .tree-leaves {
      position: absolute;
      top: 0;
      left: 10%;
      width: 80%;
      height: 70%;
      background: #2d1b0d;
      border-radius: 50%;
      border: 4px solid #1a0f06;
    }
    
    .tree-leaves::before {
      content: '';
      position: absolute;
      top: 20%;
      left: 25%;
      width: 50%;
      height: 40%;
      background: #8B0000;
      border-radius: 50%;
      animation: decay-pulse 2s infinite;
    }
    
    .vehicle {
      position: absolute;
      bottom: 33vh;
      width: 20vw;
      height: 12vh;
      min-width: 120px;
      min-height: 80px;
    }
    
    .car-body {
      position: absolute;
      bottom: 30%;
      width: 85%;
      height: 45%;
      background: linear-gradient(180deg, #333 0%, #111 100%);
      border-radius: 12px;
      border: 3px solid #666;
    }
    
    .car-windows {
      position: absolute;
      bottom: 35%;
      left: 15%;
      width: 70%;
      height: 25%;
      background: #8B0000;
      border-radius: 6px;
      opacity: 0.7;
    }
    
    .car-wheel {
      position: absolute;
      bottom: 0;
      width: 25%;
      height: 35%;
      background: #222;
      border-radius: 50%;
      border: 4px solid #444;
    }
    
    .car-wheel.left {
      left: 10%;
    }
    
    .car-wheel.right {
      right: 10%;
    }
    
    .car-damage {
      position: absolute;
      top: 10%;
      left: 40%;
      width: 20%;
      height: 20%;
      background: #8B0000;
      border-radius: 50%;
      animation: damage-smoke 3s infinite;
    }
    
    .character {
      position: absolute;
      bottom: 33vh;
      left: 20vw;
      width: 20vw;
      height: 25vh;
      min-width: 120px;
      min-height: 180px;
      z-index: 10;
      transition: all 0.3s ease;
    }
    
    .character.moving {
      animation: run 0.3s infinite;
    }
    
    .character.shooting {
      animation: recoil 0.2s ease-out;
    }
    
    .character.damaged {
      animation: damage-flash 0.5s ease-out;
    }
    
    .head {
      width: 50%;
      height: 35%;
      background: #f3c095;
      border-radius: 50%;
      position: relative;
      margin: 0 auto;
      border: 3px solid #d4a574;
    }
    
    .helmet {
      position: absolute;
      top: -10%;
      left: -10%;
      width: 120%;
      height: 60%;
      background: #333;
      border-radius: 50% 50% 0 0;
      border: 3px solid #666;
    }
    
    .helmet.damaged {
      border-color: #8B0000;
      background: #2a1a1a;
    }
    
    .eyes {
      position: absolute;
      top: 40%;
      left: 20%;
      width: 60%;
      height: 20%;
      display: flex;
      justify-content: space-between;
    }
    
    .eye {
      width: 30%;
      height: 100%;
      background: #00ff00;
      border-radius: 50%;
      animation: glow 2s infinite alternate;
    }
    
    .eye.tired {
      background: #ff6600;
      animation: tired-blink 1s infinite;
    }
    
    .body {
      width: 60%;
      height: 45%;
      background: linear-gradient(180deg, #444 0%, #222 100%);
      margin: 5% auto;
      border-radius: 8px;
      position: relative;
      border: 3px solid #666;
    }
    
    .armor-vest {
      position: absolute;
      top: 15%;
      left: 8%;
      width: 84%;
      height: 70%;
      background: #1a472a;
      border-radius: 5px;
      border: 2px solid #2d5a3d;
    }
    
    .armor-vest.damaged {
      background: #2a1a1a;
      border-color: #8B0000;
    }
    
    .legs {
      display: flex;
      justify-content: space-between;
      width: 50%;
      margin: 0 auto;
    }
    
    .leg {
      width: 35%;
      height: 20vh;
      min-height: 40px;
      background: #333;
      border-radius: 6px;
      border: 2px solid #555;
    }
    
    .weapon {
      position: absolute;
      right: -45%;
      top: 40%;
      width: 60%;
      height: 12%;
      background: linear-gradient(90deg, #666 0%, #333 100%);
      border-radius: 4px;
      transform-origin: left center;
      transition: transform 0.1s ease;
    }
    
    .weapon::before {
      content: '';
      position: absolute;
      right: 0;
      top: -30%;
      width: 25%;
      height: 160%;
      background: #444;
      border-radius: 4px;
    }
    
    .muzzle-flash {
      position: absolute;
      right: -40%;
      top: -100%;
      width: 80%;
      height: 300%;
      background: radial-gradient(circle, #ffff00 0%, #ff6600 50%, transparent 70%);
      border-radius: 50%;
      opacity: 0;
      transform: scale(0);
    }
    
    .muzzle-flash.active {
      animation: flash 0.1s ease-out;
    }
    
    .zombie {
      position: absolute;
      width: 15vw;
      height: 20vh;
      min-width: 90px;
      min-height: 140px;
      bottom: 33vh;
      z-index: 8;
    }
    
    .zombie.attacking {
      animation: zombie-attack 0.5s ease-in-out;
    }
    
    .zombie-head {
      width: 50%;
      height: 35%;
      background: #4a5d23;
      border-radius: 50%;
      margin: 0 auto;
      position: relative;
      border: 3px solid #2d3516;
    }
    
    .zombie-eyes {
      position: absolute;
      top: 40%;
      left: 20%;
      width: 60%;
      height: 20%;
      display: flex;
      justify-content: space-between;
    }
    
    .zombie-eye {
      width: 30%;
      height: 100%;
      background: #ff0000;
      border-radius: 50%;
      animation: zombie-glow 1s infinite alternate;
    }
    
    .zombie-body {
      width: 60%;
      height: 45%;
      background: #3d4a1f;
      margin: 5% auto;
      border-radius: 5px;
      border: 3px solid #2d3516;
    }
    
    .zombie-legs {
      display: flex;
      justify-content: space-between;
      width: 50%;
      margin: 0 auto;
    }
    
    .zombie-leg {
      width: 35%;
      height: 15vh;
      min-height: 30px;
      background: #2d3516;
      border-radius: 4px;
    }
    
    .bullet {
      position: absolute;
      width: 4vw;
      height: 2vh;
      min-width: 20px;
      min-height: 12px;
      background: #ffff00;
      border-radius: 50%;
      z-index: 9;
      box-shadow: 0 0 15px #ffff00;
    }
    
    .explosion {
      position: absolute;
      width: 25vw;
      height: 25vw;
      min-width: 150px;
      min-height: 150px;
      border-radius: 50%;
      z-index: 11;
      pointer-events: none;
    }
    
    .bomb {
      position: absolute;
      width: 8vw;
      height: 8vw;
      min-width: 40px;
      min-height: 40px;
      background: #333;
      border-radius: 50%;
      border: 4px solid #666;
      z-index: 9;
    }
    
    .bomb::before {
      content: '';
      position: absolute;
      top: -25%;
      left: 50%;
      transform: translateX(-50%);
      width: 8%;
      height: 25%;
      background: #ff6600;
      animation: fuse 2s linear infinite;
    }
    
    .health-bar {
      position: absolute;
      top: 3vh;
      left: 3vw;
      width: 50vw;
      height: 6vh;
      min-height: 30px;
      background: #333;
      border: 3px solid #666;
      border-radius: 15px;
      overflow: hidden;
      z-index: 20;
    }
    
    .health-fill {
      height: 100%;
      background: linear-gradient(90deg, #00ff00 0%, #ffff00 50%, #ff0000 100%);
      transition: width 0.3s ease;
      border-radius: 12px;
    }
    
    .health-text {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: bold;
      font-size: 4vw;
      min-font-size: 16px;
      text-shadow: 2px 2px 4px #000;
    }
    
    .progress-bar {
      position: absolute;
      top: 10vh;
      left: 3vw;
      width: 60vw;
      height: 3vh;
      min-height: 15px;
      background: #333;
      border: 2px solid #666;
      border-radius: 8px;
      overflow: hidden;
      z-index: 20;
    }
    
    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #0066ff 0%, #00ff66 100%);
      width: 0%;
      transition: width 0.1s linear;
    }
    
    .hud {
      position: absolute;
      top: 15vh;
      left: 3vw;
      color: #00ff00;
      font-family: 'Courier New', monospace;
      font-size: 4.5vw;
      min-font-size: 18px;
      text-shadow: 0 0 10px #00ff00;
      z-index: 20;
      line-height: 1.2;
    }
    
    .distance-marker {
      position: absolute;
      top: 15vh;
      right: 3vw;
      color: #ffff00;
      font-family: 'Courier New', monospace;
      font-size: 5vw;
      min-font-size: 20px;
      text-shadow: 0 0 10px #ffff00;
      z-index: 20;
    }
    
    .damage-indicator {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      color: #ff0000;
      font-size: 8vw;
      min-font-size: 32px;
      font-weight: bold;
      text-shadow: 3px 3px 6px #000;
      opacity: 0;
      z-index: 25;
      pointer-events: none;
    }
    
    .mobile-controls {
      position: absolute;
      bottom: 0;
      left: 0;
      width: 100%;
      height: 25vh;
      z-index: 30;
      pointer-events: none;
    }
    
    .joystick {
      position: absolute;
      bottom: 5vh;
      left: 5vw;
      width: 20vw;
      height: 20vw;
      min-width: 100px;
      min-height: 100px;
      background: rgba(255, 255, 255, 0.1);
      border: 3px solid rgba(255, 255, 255, 0.3);
      border-radius: 50%;
      pointer-events: all;
      touch-action: none;
    }
    
    .joystick-knob {
      position: absolute;
      top: 50%;
      left: 50%;
      width: 40%;
      height: 40%;
      background: rgba(255, 255, 255, 0.8);
      border-radius: 50%;
      transform: translate(-50%, -50%);
      box-shadow: 0 0 10px rgba(255, 255, 255, 0.5);
    }
    
    .fire-button {
      position: absolute;
      bottom: 5vh;
      right: 5vw;
      width: 18vw;
      height: 18vw;
      min-width: 90px;
      min-height: 90px;
      background: rgba(255, 0, 0, 0.7);
      border: 3px solid rgba(255, 0, 0, 0.9);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 6vw;
      min-font-size: 24px;
      font-weight: bold;
      text-shadow: 2px 2px 4px #000;
      pointer-events: all;
      touch-action: manipulation;
      user-select: none;
    }
    
    .fire-button:active {
      transform: scale(0.95);
      background: rgba(255, 0, 0, 0.9);
    }
    
    .bomb-button {
      position: absolute;
      bottom: 5vh;
      right: 25vw;
      width: 15vw;
      height: 15vw;
      min-width: 75px;
      min-height: 75px;
      background: rgba(255, 165, 0, 0.7);
      border: 3px solid rgba(255, 165, 0, 0.9);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 5vw;
      min-font-size: 20px;
      font-weight: bold;
      text-shadow: 2px 2px 4px #000;
      pointer-events: all;
      touch-action: manipulation;
      user-select: none;
    }
    
    .bomb-button:active {
      transform: scale(0.95);
      background: rgba(255, 165, 0, 0.9);
    }
    
    .game-over {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      color: #ff0000;
      font-size: 12vw;
      min-font-size: 48px;
      font-weight: bold;
      text-shadow: 0 0 20px #ff0000;
      z-index: 30;
      text-align: center;
      display: none;
    }
    
    .restart-button {
      position: absolute;
      bottom: 30vh;
      left: 50%;
      transform: translateX(-50%);
      padding: 4vw 8vw;
      background: rgba(0, 255, 0, 0.8);
      border: 3px solid #00ff00;
      border-radius: 15px;
      color: white;
      font-size: 6vw;
      min-font-size: 24px;
      font-weight: bold;
      text-shadow: 2px 2px 4px #000;
      pointer-events: all;
      touch-action: manipulation;
      user-select: none;
      display: none;
      z-index: 31;
    }
    
    .restart-button:active {
      transform: translateX(-50%) scale(0.95);
      background: rgba(0, 255, 0, 1);
    }
    
    /* Animations */
    @keyframes scroll-bg {
      0% { transform: translateX(0); }
      100% { transform: translateX(-50%); }
    }
    
    @keyframes scroll-env {
      0% { transform: translateX(0); }
      100% { transform: translateX(-50%); }
    }
    
    @keyframes run {
      0%, 100% { transform: translateY(0) rotate(0deg); }
      25% { transform: translateY(-2vh) rotate(-2deg); }
      75% { transform: translateY(-2vh) rotate(2deg); }
    }
    
    @keyframes recoil {
      0% { transform: translateX(0); }
      50% { transform: translateX(-2vw); }
      100% { transform: translateX(0); }
    }
    
    @keyframes damage-flash {
      0%, 100% { filter: brightness(1); }
      50% { filter: brightness(2) hue-rotate(0deg); }
    }
    
    @keyframes zombie-attack {
      0% { transform: translateX(0) scale(1); }
      50% { transform: translateX(-5vw) scale(1.2); }
      100% { transform: translateX(0) scale(1); }
    }
    
    @keyframes glow {
      0% { box-shadow: 0 0 8px #00ff00; }
      100% { box-shadow: 0 0 20px #00ff00, 0 0 30px #00ff00; }
    }
    
    @keyframes tired-blink {
      0%, 90% { height: 100%; opacity: 1; }
      95% { height: 30%; opacity: 0.5; }
    }
    
    @keyframes zombie-glow {
      0% { box-shadow: 0 0 5px #ff0000; }
      100% { box-shadow: 0 0 15px #ff0000; }
    }
    
    @keyframes flash {
      0% { opacity: 0; transform: scale(0); }
      50% { opacity: 1; transform: scale(1.5); }
      100% { opacity: 0; transform: scale(2); }
    }
    
    @keyframes fuse {
      0% { background: #ff6600; }
      50% { background: #ffff00; }
      100% { background: #ff0000; }
    }
    
    @keyframes explode {
      0% {
        transform: scale(0);
        background: radial-gradient(circle, #ffff00 0%, #ff6600 30%, #ff0000 70%, transparent 100%);
        opacity: 1;
      }
      50% {
        transform: scale(1);
        background: radial-gradient(circle, #ffffff 0%, #ffff00 20%, #ff6600 50%, #ff0000 80%, transparent 100%);
        opacity: 1;
      }
      100% {
        transform: scale(2);
        background: radial-gradient(circle, transparent 0%, transparent 100%);
        opacity: 0;
      }
    }
    
    @keyframes decay-pulse {
      0%, 100% { opacity: 0.3; transform: scale(1); }
      50% { opacity: 0.8; transform: scale(1.2); }
    }
    
    @keyframes damage-smoke {
      0% { opacity: 0.8; transform: translateY(0) scale(1); }
      100% { opacity: 0; transform: translateY(-5vh) scale(1.5); }
    }
    
    @keyframes damage-text {
      0% { opacity: 1; transform: translate(-50%, -50%) scale(1); }
      100% { opacity: 0; transform: translate(-50%, -15vh) scale(1.5); }
    }
    
    /* Responsive adjustments */
    @media (max-width: 480px) {
      .hud {
        font-size: 5vw;
      }
      
      .distance-marker {
        font-size: 6vw;
      }
      
      .health-text {
        font-size: 5vw;
      }
    }
    
    @media (orientation: landscape) and (max-height: 500px) {
      .character {
        bottom: 40vh;
      }
      
      .zombie {
        bottom: 40vh;
      }
      
      .tree {
        bottom: 40vh;
        height: 35vh;
      }
      
      .vehicle {
        bottom: 40vh;
      }
      
      .underground {
        height: 35vh;
      }
      
      .ground-surface {
        bottom: 35vh;
      }
    }
  </style>
</head>
<body>
  <div class="game-container">
    <div class="background"></div>
    
    <div class="environment" id="environment"></div>
    
    <div class="underground"></div>
    <div class="ground-surface"></div>
    
    <div class="character" id="player">
      <div class="head">
        <div class="helmet" id="helmet"></div>
        <div class="eyes">
          <div class="eye" id="leftEye"></div>
          <div class="eye" id="rightEye"></div>
        </div>
      </div>
      <div class="body">
        <div class="armor-vest" id="armorVest"></div>
      </div>
      <div class="legs">
        <div class="leg"></div>
        <div class="leg"></div>
      </div>
      <div class="weapon" id="weapon">
        <div class="muzzle-flash" id="muzzleFlash"></div>
      </div>
    </div>
    
    <div class="damage-indicator" id="damageIndicator">-25 HP</div>
    
    <div class="health-bar">
      <div class="health-fill" id="healthFill" style="width: 100%;"></div>
      <div class="health-text" id="healthText">100</div>
    </div>
    
    <div class="progress-bar">
      <div class="progress-fill" id="progressFill"></div>
    </div>
    
    <div class="distance-marker">
      <span id="distance">0</span>m
    </div>
    
    <div class="hud">
      <div>SCORE: <span id="score">0</span></div>
      <div>WAVE: <span id="wave">1</span></div>
    </div>
    
    <div class="mobile-controls">
      <div class="joystick" id="joystick">
        <div class="joystick-knob" id="joystickKnob"></div>
      </div>
      <div class="bomb-button" id="bombButton">💣</div>
      <div class="fire-button" id="fireButton">🔥</div>
    </div>
    
    <div class="game-over" id="gameOver">
      <div>GAME OVER</div>
      <div style="font-size: 6vw; margin-top: 3vh;">Final Score: <span id="finalScore">0</span></div>
      <div style="font-size: 4vw; margin-top: 2vh;">Distance: <span id="finalDistance">0</span>m</div>
    </div>
    
    <div class="restart-button" id="restartButton">RESTART</div>
  </div>

  <script>
    class MobileZombieGame {
      constructor() {
        this.player = document.getElementById('player');
        this.weapon = document.getElementById('weapon');
        this.muzzleFlash = document.getElementById('muzzleFlash');
        this.gameContainer = document.querySelector('.game-container');
        this.environment = document.getElementById('environment');
        
        this.playerPos = { x: window.innerWidth * 0.2, y: window.innerHeight * 0.33 };
        this.joystickPos = { x: 0, y: 0 };
        this.bullets = [];
        this.zombies = [];
        this.explosions = [];
        this.bombs = [];
        this.environmentObjects = [];
        
        this.score = 0;
        this.health = 100;
        this.maxHealth = 100;
        this.distance = 0;
        this.wave = 1;
        this.gameRunning = true;
        this.gameSpeed = 1;
        this.lastDamageTime = 0;
        this.lastBombTime = 0;
        this.lastFireTime = 0;
        this.autoShoot = false;
        this.bombCooldown = 3000; // 3 seconds
        this.fireCooldown = 200; // 0.2 seconds
        
        this.init();
      }
      
      init() {
        this.bindEvents();
        this.setupProgressBar();
        this.createEnvironment();
        this.gameLoop();
        this.spawnZombies();
        this.updateMovement();
      }
      
      bindEvents() {
        // Mobile joystick
        const joystick = document.getElementById('joystick');
        const joystickKnob = document.getElementById('joystickKnob');
        let joystickActive = false;
        let joystickCenter = { x: 0, y: 0 };
        
        joystick.addEventListener('touchstart', (e) => {
          e.preventDefault();
          joystickActive = true;
          const rect = joystick.getBoundingClientRect();
          joystickCenter.x = rect.left + rect.width / 2;
          joystickCenter.y = rect.top + rect.height / 2;
        });
        
        joystick.addEventListener('touchmove', (e) => {
          if (!joystickActive) return;
          e.preventDefault();
          
          const touch = e.touches[0];
          const deltaX = touch.clientX - joystickCenter.x;
          const deltaY = touch.clientY - joystickCenter.y;
          const distance = Math.sqrt(deltaX * deltaX + deltaY * deltaY);
          const maxDistance = joystick.offsetWidth / 2;
          
          if (distance <= maxDistance) {
            this.joystickPos.x = deltaX / maxDistance;
            this.joystickPos.y = deltaY / maxDistance;
            joystickKnob.style.transform = `translate(-50%, -50%) translate(${deltaX}px, ${deltaY}px)`;
          } else {
            const angle = Math.atan2(deltaY, deltaX);
            const limitedX = Math.cos(angle) * maxDistance;
            const limitedY = Math.sin(angle) * maxDistance;
            this.joystickPos.x = limitedX / maxDistance;
            this.joystickPos.y = limitedY / maxDistance;
            joystickKnob.style.transform = `translate(-50%, -50%) translate(${limitedX}px, ${limitedY}px)`;
          }
        });

        joystick.addEventListener('touchend', (e) => {
          e.preventDefault();
          joystickActive = false;
          this.joystickPos.x = 0;
          this.joystickPos.y = 0;
          joystickKnob.style.transform = 'translate(-50%, -50%)';
        });

        // Fire button
        const fireButton = document.getElementById('fireButton');
        fireButton.addEventListener('touchstart', (e) => {
          e.preventDefault();
          this.autoShoot = true;
          this.shoot();
        });

        fireButton.addEventListener('touchend', (e) => {
          e.preventDefault();
          this.autoShoot = false;
        });

        // Bomb button
        const bombButton = document.getElementById('bombButton');
        bombButton.addEventListener('touchstart', (e) => {
          e.preventDefault();
          this.throwBomb();
        });

        // Restart button
        const restartButton = document.getElementById('restartButton');
        restartButton.addEventListener('touchstart', (e) => {
          e.preventDefault();
          this.restartGame();
        });

        // Prevent default touch behaviors
        document.addEventListener('touchmove', (e) => {
          e.preventDefault();
        }, { passive: false });

        document.addEventListener('touchstart', (e) => {
          e.preventDefault();
        }, { passive: false });
      }

      setupProgressBar() {
        this.progressFill = document.getElementById('progressFill');
        this.progressTarget = 100; // Distance to next wave
        this.progressCurrent = 0;
      }

      updateMovement() {
        if (!this.gameRunning) return;

        // Update player position based on joystick
        if (Math.abs(this.joystickPos.x) > 0.1 || Math.abs(this.joystickPos.y) > 0.1) {
          const speed = 5;
          const newX = this.playerPos.x + this.joystickPos.x * speed;
          const newY = this.playerPos.y - this.joystickPos.y * speed;

          // Boundary checks
          const playerWidth = this.player.offsetWidth;
          const playerHeight = this.player.offsetHeight;
          
          if (newX >= 0 && newX <= window.innerWidth - playerWidth) {
            this.playerPos.x = newX;
          }
          
          if (newY >= window.innerHeight * 0.2 && newY <= window.innerHeight * 0.7) {
            this.playerPos.y = newY;
          }

          this.player.style.left = this.playerPos.x + 'px';
          this.player.style.bottom = (window.innerHeight - this.playerPos.y - playerHeight) + 'px';
          
          this.player.classList.add('moving');
        } else {
          this.player.classList.remove('moving');
        }

        // Auto shoot
        if (this.autoShoot) {
          this.shoot();
        }

        requestAnimationFrame(() => this.updateMovement());
      }

      shoot() {
        const now = Date.now();
        if (now - this.lastFireTime < this.fireCooldown) return;
        
        this.lastFireTime = now;
        
        // Create bullet
        const bullet = document.createElement('div');
        bullet.className = 'bullet';
        
        const weaponRect = this.weapon.getBoundingClientRect();
        const bulletStartX = weaponRect.right;
        const bulletStartY = weaponRect.top + weaponRect.height / 2;
        
        bullet.style.left = bulletStartX + 'px';
        bullet.style.top = bulletStartY + 'px';
        
        this.gameContainer.appendChild(bullet);
        
        this.bullets.push({
          element: bullet,
          x: bulletStartX,
          y: bulletStartY,
          speed: 15
        });

        // Muzzle flash effect
        this.muzzleFlash.classList.add('active');
        setTimeout(() => {
          this.muzzleFlash.classList.remove('active');
        }, 100);

        // Player recoil animation
        this.player.classList.add('shooting');
        setTimeout(() => {
          this.player.classList.remove('shooting');
        }, 200);
      }

      throwBomb() {
        const now = Date.now();
        if (now - this.lastBombTime < this.bombCooldown) return;
        
        this.lastBombTime = now;
        
        const bomb = document.createElement('div');
        bomb.className = 'bomb';
        
        const playerRect = this.player.getBoundingClientRect();
        const bombX = playerRect.right + 20;
        const bombY = playerRect.top + playerRect.height / 2;
        
        bomb.style.left = bombX + 'px';
        bomb.style.top = bombY + 'px';
        
        this.gameContainer.appendChild(bomb);
        
        this.bombs.push({
          element: bomb,
          x: bombX,
          y: bombY,
          speed: 8,
          timer: 2000 // 2 seconds until explosion
        });
      }

      createEnvironment() {
        // Create random environment objects
        for (let i = 0; i < 10; i++) {
          setTimeout(() => {
            this.spawnEnvironmentObject();
          }, i * 2000);
        }
      }

      spawnEnvironmentObject() {
        if (!this.gameRunning) return;

        const objects = [
          { class: 'tree', html: '<div class="tree-trunk"></div><div class="tree-leaves"></div>' },
          { class: 'vehicle', html: '<div class="car-body"></div><div class="car-windows"></div><div class="car-wheel left"></div><div class="car-wheel right"></div><div class="car-damage"></div>' }
        ];

        const randomObj = objects[Math.floor(Math.random() * objects.length)];
        const obj = document.createElement('div');
        obj.className = randomObj.class;
        obj.innerHTML = randomObj.html;
        obj.style.right = '-20vw';
        
        this.environment.appendChild(obj);
        
        this.environmentObjects.push({
          element: obj,
          x: window.innerWidth + 100,
          speed: 2 + Math.random() * 3
        });

        // Schedule next object
        setTimeout(() => {
          this.spawnEnvironmentObject();
        }, 3000 + Math.random() * 4000);
      }

      spawnZombies() {
        if (!this.gameRunning) return;

        const zombie = document.createElement('div');
        zombie.className = 'zombie';
        zombie.innerHTML = `
          <div class="zombie-head">
            <div class="zombie-eyes">
              <div class="zombie-eye"></div>
              <div class="zombie-eye"></div>
            </div>
          </div>
          <div class="zombie-body"></div>
          <div class="zombie-legs">
            <div class="zombie-leg"></div>
            <div class="zombie-leg"></div>
          </div>
        `;
        
        zombie.style.right = '-15vw';
        zombie.style.bottom = '33vh';
        
        this.gameContainer.appendChild(zombie);
        
        this.zombies.push({
          element: zombie,
          x: window.innerWidth + 100,
          y: window.innerHeight * 0.33,
          health: 3,
          speed: 1 + Math.random() * 2,
          attacking: false,
          lastAttack: 0
        });

        // Schedule next zombie based on wave
        const spawnDelay = Math.max(500, 3000 - (this.wave * 200));
        setTimeout(() => {
          this.spawnZombies();
        }, spawnDelay);
      }

      updateBullets() {
        this.bullets.forEach((bullet, index) => {
          bullet.x += bullet.speed;
          bullet.element.style.left = bullet.x + 'px';
          
          // Remove bullets that are off screen
          if (bullet.x > window.innerWidth + 50) {
            bullet.element.remove();
            this.bullets.splice(index, 1);
          }
        });
      }

      updateBombs() {
        this.bombs.forEach((bomb, index) => {
          bomb.x += bomb.speed;
          bomb.timer -= 16; // Roughly 60fps
          
          bomb.element.style.left = bomb.x + 'px';
          
          // Explode bomb
          if (bomb.timer <= 0 || bomb.x > window.innerWidth + 50) {
            this.explodeBomb(bomb.x, bomb.y);
            bomb.element.remove();
            this.bombs.splice(index, 1);
          }
        });
      }

      explodeBomb(x, y) {
        const explosion = document.createElement('div');
        explosion.className = 'explosion';
        explosion.style.left = (x - 75) + 'px';
        explosion.style.top = (y - 75) + 'px';
        explosion.style.animation = 'explode 0.8s ease-out';
        
        this.gameContainer.appendChild(explosion);
        
        // Remove zombies in explosion radius
        this.zombies.forEach((zombie, index) => {
          const zombieRect = zombie.element.getBoundingClientRect();
          const distance = Math.sqrt(
            Math.pow(zombieRect.left - x, 2) + 
            Math.pow(zombieRect.top - y, 2)
          );
          
          if (distance < 150) {
            this.killZombie(index);
          }
        });
        
        setTimeout(() => {
          explosion.remove();
        }, 800);
      }

      updateZombies() {
        this.zombies.forEach((zombie, index) => {
          zombie.x -= zombie.speed * this.gameSpeed;
          zombie.element.style.right = (window.innerWidth - zombie.x) + 'px';
          
          // Check collision with player
          const zombieRect = zombie.element.getBoundingClientRect();
          const playerRect = this.player.getBoundingClientRect();
          
          if (this.isColliding(zombieRect, playerRect)) {
            const now = Date.now();
            if (!zombie.attacking && now - zombie.lastAttack > 1000) {
              zombie.attacking = true;
              zombie.lastAttack = now;
              zombie.element.classList.add('attacking');
              
              this.takeDamage(25);
              
              setTimeout(() => {
                if (zombie.element) {
                  zombie.element.classList.remove('attacking');
                  zombie.attacking = false;
                }
              }, 500);
            }
          }
          
          // Remove zombies that are off screen
          if (zombie.x < -100) {
            zombie.element.remove();
            this.zombies.splice(index, 1);
          }
        });
      }

      updateCollisions() {
        // Bullet vs Zombie collisions
        this.bullets.forEach((bullet, bulletIndex) => {
          this.zombies.forEach((zombie, zombieIndex) => {
            const bulletRect = bullet.element.getBoundingClientRect();
            const zombieRect = zombie.element.getBoundingClientRect();
            
            if (this.isColliding(bulletRect, zombieRect)) {
              // Remove bullet
              bullet.element.remove();
              this.bullets.splice(bulletIndex, 1);
              
              // Damage zombie
              zombie.health--;
              if (zombie.health <= 0) {
                this.killZombie(zombieIndex);
              }
            }
          });
        });
      }

      killZombie(index) {
        if (this.zombies[index]) {
          this.zombies[index].element.remove();
          this.zombies.splice(index, 1);
          this.score += 10;
          this.updateScore();
        }
      }

      isColliding(rect1, rect2) {
        return !(rect1.right < rect2.left || 
                rect1.left > rect2.right || 
                rect1.bottom < rect2.top || 
                rect1.top > rect2.bottom);
      }

      takeDamage(amount) {
        const now = Date.now();
        if (now - this.lastDamageTime < 500) return; // Damage immunity
        
        this.lastDamageTime = now;
        this.health -= amount;
        
        if (this.health < 0) this.health = 0;
        
        this.updateHealth();
        this.showDamageIndicator(amount);
        
        // Visual damage effect
        this.player.classList.add('damaged');
        setTimeout(() => {
          this.player.classList.remove('damaged');
        }, 500);
        
        // Update armor/helmet damage visual
        if (this.health < 70) {
          document.getElementById('helmet').classList.add('damaged');
          document.getElementById('armorVest').classList.add('damaged');
        }
        
        if (this.health < 30) {
          document.getElementById('leftEye').classList.add('tired');
          document.getElementById('rightEye').classList.add('tired');
        }
        
        if (this.health <= 0) {
          this.gameOver();
        }
      }

      showDamageIndicator(amount) {
        const indicator = document.getElementById('damageIndicator');
        indicator.textContent = `-${amount} HP`;
        indicator.style.animation = 'damage-text 1s ease-out';
        
        setTimeout(() => {
          indicator.style.animation = '';
        }, 1000);
      }

      updateHealth() {
        const healthPercentage = (this.health / this.maxHealth) * 100;
        document.getElementById('healthFill').style.width = healthPercentage + '%';
        document.getElementById('healthText').textContent = this.health;
      }

      updateScore() {
        document.getElementById('score').textContent = this.score;
      }

      updateDistance() {
        this.distance += this.gameSpeed;
        document.getElementById('distance').textContent = Math.floor(this.distance);
        
        // Update progress bar
        this.progressCurrent = this.distance % this.progressTarget;
        const progressPercentage = (this.progressCurrent / this.progressTarget) * 100;
        this.progressFill.style.width = progressPercentage + '%';
        
        // Check for wave progression
        if (this.distance > 0 && this.distance % this.progressTarget === 0) {
          this.nextWave();
        }
      }

      nextWave() {
        this.wave++;
        this.gameSpeed += 0.2;
        document.getElementById('wave').textContent = this.wave;
        
        // Show wave indicator (you could add visual feedback here)
        console.log(`Wave ${this.wave}!`);
      }

      updateEnvironment() {
        this.environmentObjects.forEach((obj, index) => {
          obj.x -= obj.speed * this.gameSpeed;
          obj.element.style.right = (window.innerWidth - obj.x) + 'px';
          
          if (obj.x < -200) {
            obj.element.remove();
            this.environmentObjects.splice(index, 1);
          }
        });
      }

      gameLoop() {
        if (!this.gameRunning) return;
        
        this.updateBullets();
        this.updateBombs();
        this.updateZombies();
        this.updateCollisions();
        this.updateDistance();
        this.updateEnvironment();
        
        requestAnimationFrame(() => this.gameLoop());
      }

      gameOver() {
        this.gameRunning = false;
        
        document.getElementById('finalScore').textContent = this.score;
        document.getElementById('finalDistance').textContent = Math.floor(this.distance);
        document.getElementById('gameOver').style.display = 'block';
        document.getElementById('restartButton').style.display = 'block';
      }

      restartGame() {
        // Reset game state
        this.gameRunning = true;
        this.score = 0;
        this.health = 100;
        this.distance = 0;
        this.wave = 1;
        this.gameSpeed = 1;
        this.lastDamageTime = 0;
        this.lastBombTime = 0;
        this.lastFireTime = 0;
        this.progressCurrent = 0;
        
        // Clear arrays
        this.bullets.forEach(bullet => bullet.element.remove());
        this.zombies.forEach(zombie => zombie.element.remove());
        this.bombs.forEach(bomb => bomb.element.remove());
        this.environmentObjects.forEach(obj => obj.element.remove());
        
        this.bullets = [];
        this.zombies = [];
        this.bombs = [];
        this.environmentObjects = [];
        
        // Reset UI
        this.updateHealth();
        this.updateScore();
        document.getElementById('wave').textContent = this.wave;
        document.getElementById('distance').textContent = '0';
        this.progressFill.style.width = '0%';
        
        // Reset player visuals
        document.getElementById('helmet').classList.remove('damaged');
        document.getElementById('armorVest').classList.remove('damaged');
        document.getElementById('leftEye').classList.remove('tired');
        document.getElementById('rightEye').classList.remove('tired');
        
        // Hide game over screen
        document.getElementById('gameOver').style.display = 'none';
        document.getElementById('restartButton').style.display = 'none';
        
        // Reset player position
        this.playerPos = { x: window.innerWidth * 0.2, y: window.innerHeight * 0.33 };
        this.player.style.left = this.playerPos.x + 'px';
        this.player.style.bottom = (window.innerHeight - this.playerPos.y - this.player.offsetHeight) + 'px';
        
        // Restart game loops
        this.createEnvironment();
        this.spawnZombies();
        this.gameLoop();
      }
    }

    // Start the game when the page loads
    window.addEventListener('load', () => {
      new MobileZombieGame();
    });
  </script>
</body>
</html>
